<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <title>WebRTC Audio Player i Chat</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
        }
        #audioPlayer {
            margin-bottom: 20px; /* Razmak između audio player-a i chata */
        }
    </style>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body>
    <audio id="audioPlayer" autoplay controls></audio> <!-- Dodate kontrole za audio -->
    <div id="chat">
        <p>Chat ide ovde...</p>
    </div>

    <script>
        const audioPlayer = document.getElementById('audioPlayer');
        const socket = io(); // Poveži se sa signaling serverom
        const peerConnection = new RTCPeerConnection();

        async function startStreaming() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log("Lokalni audio stream:", stream);

                // Poveži lokalni audio stream
                stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

                peerConnection.ontrack = (event) => {
                    const remoteAudioStream = event.streams[0];
                    audioPlayer.srcObject = remoteAudioStream;
                    console.log("Audio stream povezan:", remoteAudioStream);
                    console.log("Broj audio track-ova:", remoteAudioStream.getAudioTracks().length);

                    // Logovanje svakog audio track-a
                    remoteAudioStream.getAudioTracks().forEach(track => {
                        console.log("Audio track:", track);
                    });
                };

                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        socket.emit('ice-candidate', event.candidate);
                        console.log("ICE kandidat poslat:", event.candidate);
                    }
                };

                // Kreiraj ponudu i pošalji je
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                socket.emit('sdp-offer', offer);
                console.log("SDP ponuda poslata:", offer);

                // Očekuj SDP odgovor
                socket.on('sdp-answer', async (answer) => {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                    console.log("SDP odgovor primljen:", answer);
                });

                // Očekuj ICE kandidate od drugog korisnika
                socket.on('ice-candidate', (candidate) => {
                    peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    console.log("ICE kandidat primljen:", candidate);
                });

            } catch (error) {
                console.error("Greška pri pristupu audio stream-u:", error);
            }
        }

        // Pozovi funkciju da započne streaming
        startStreaming();
    </script>
</body>
</html>
